<div class="wrapper">
  <!-- Header -->
  <div class="header">
    <div class="title">
      <p>Environments <span class="beta-tag">beta</span></p>
    </div>
    <div class="actions" *ngIf="templateStatus === 'envs' && environmentObjectArray!.length > 0">
      <span class="env-count">{{ environmentObjectArray!.length }}</span>
      <mat-icon 
        [class.disabled]="environmentObjectArray!.length >= MAX_ENVIRONMENTS_LIMIT" 
        class="pointer"
        matTooltip="{{ environmentObjectArray!.length >= MAX_ENVIRONMENTS_LIMIT ? 'Max limit reached' : 'Create environment' }}"
        (click)="environmentObjectArray!.length < MAX_ENVIRONMENTS_LIMIT && openCreateEnvironmentDialog()">
        add_circle_outline
      </mat-icon>
      <mat-icon class="pointer" matTooltip="Delete all environments" (click)="deleteAllEnvironmentsDialog()">
        delete_sweep
      </mat-icon>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="templateStatus === 'loading'" class="loading">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <!-- Content -->
  <div class="container" *ngIf="templateStatus !== 'loading'">
    
    <!-- Login Required -->
    <div class="login" *ngIf="templateStatus === 'login'">
      <mat-icon class="login-icon">lock</mat-icon>
      <span class="login-title">Login Required</span>
      <span class="login-subtitle">Please log in to manage your environments</span>
      <button mat-flat-button color="primary" (click)="logInOut()">Login</button>
    </div>

    <!-- Environment List -->
    <div class="environment-list" *ngIf="templateStatus === 'envs'">
      
      <!-- Empty State -->
      <div *ngIf="environmentObjectArray !== null && environmentObjectArray.length === 0" class="empty-state">
        <mat-icon class="empty-icon">cloud_queue</mat-icon>
        <span class="empty-title">No environments yet</span>
        <span class="empty-subtitle">Create your first analysis environment to get started</span>
        <button mat-flat-button color="primary" (click)="openCreateEnvironmentDialog()" [disabled]="MAX_ENVIRONMENTS_LIMIT <= 0">
          <mat-icon>add</mat-icon>
          Create Environment
        </button>
        <span class="limit-info-text">Max {{ MAX_ENVIRONMENTS_LIMIT }} environments allowed during beta</span>
      </div>

      <!-- Environment Cards -->
      <div 
        *ngFor="let environment of environmentObjectArray" 
        class="environment-card"
        [class.expanded]="expandedEnvironment !== null && expandedEnvironment.id === environment.id">
        
        <!-- Card Header -->
        <div class="card-header" (click)="expandedEnvironment = expandedEnvironment !== null && expandedEnvironment.id === environment.id ? null : environment; select(expandedEnvironment)">
          <div class="card-title-row">
            <span class="card-title">{{ environment.name }}</span>
            <div class="status-badge" [ngClass]="environment.status | lowercase">
              <mat-icon class="status-icon">{{ environment.statusIcon }}</mat-icon>
              <span>{{ environment.statusText }}</span>
            </div>
          </div>
          <div class="card-subtitle" *ngIf="environment.description">{{ environment.description }}</div>
        </div>

        <!-- Card Meta -->
        <div class="card-meta">
          <div class="meta-item">
            <mat-icon>memory</mat-icon>
            <span>{{ environment.type }}</span>
          </div>
          <div class="meta-item">
            <mat-icon>cloud</mat-icon>
            <span>{{ environment.provider }}</span>
          </div>
          <div class="meta-item">
            <mat-icon>schedule</mat-icon>
            <span>{{ environment.created }}</span>
          </div>
        </div>

        <!-- Card Actions -->
        <div class="card-actions">
          <button mat-icon-button matTooltip="Edit environment" (click)="openCreateEnvironmentDialog(environment); $event.stopPropagation()">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button matTooltip="Delete environment" (click)="deleteEnvironmentDialog(environment); $event.stopPropagation()">
            <mat-icon>delete</mat-icon>
          </button>
          <button 
            mat-icon-button 
            [matTooltip]="environment.enable ? 'Open environment' : 'Environment not ready'"
            [disabled]="!environment.enable"
            (click)="openInBrowser(environment.accessUrl); $event.stopPropagation()">
            <mat-icon>open_in_new</mat-icon>
          </button>
          <span class="spacer"></span>
          <button 
            mat-icon-button 
            class="expand-btn"
            [matTooltip]="expandedEnvironment !== null && environment.id === expandedEnvironment.id ? 'Collapse' : 'Show resources'"
            (click)="expandedEnvironment = expandedEnvironment !== null && expandedEnvironment.id === environment.id ? null : environment; select(expandedEnvironment)">
            <mat-icon [class.rotated]="expandedEnvironment !== null && environment.id === expandedEnvironment.id">expand_more</mat-icon>
          </button>
        </div>

        <!-- Expanded Content: Resources -->
        <div class="card-content" *ngIf="expandedEnvironment?.id === environment.id">
          <div class="resources-header">
            <span class="resources-title">Resources</span>
            <span class="resources-count" *ngIf="environment.resources.length > 0">{{ environment.resources.length }}</span>
          </div>
          
          <div class="resources-list">
            <app-analysis-resources 
              *ngIf="environment.resources.length > 0" 
              [resources]="environment.resources"
              [environment]="environment" 
              (deleteResourceCall)="deleteResource($event)"
              (openParametersDialogCall)="openParametersDialog($event)"
              (cloneResourceCall)="cloneResource($event)">
            </app-analysis-resources>

            <div class="drag-area" *ngIf="environment.resources.length === 0">
              <mat-icon class="drag-icon">move_to_inbox</mat-icon>
              <span class="drag-text">
                Add resources using the <mat-icon class="inline-icon">move_to_inbox</mat-icon> icon from search results
              </span>
            </div>
          </div>

          <div class="resources-actions">
            <button 
              mat-flat-button 
              color="primary"
              [matTooltip]="environment.buttonRunText + ' environment'"
              [disabled]="!environment.buttonRunEnabled"
              (click)="openRun(environment)">
              <mat-icon>{{ environment.buttonRunText === 'Run' ? 'play_arrow' : 'refresh' }}</mat-icon>
              {{ environment.buttonRunText }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
